name: AI Auto Fix

on:
  workflow_run:
    workflows: ["test"]
    types: [completed]

jobs:
  auto_fix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write
      actions: read

    steps:
      - run: gh --version || (sudo apt-get update && sudo apt-get install gh -y)

      - name: Auth gh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: echo "$GH_TOKEN" | gh auth login --with-token

      - name: Download logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for i in 1 2 3; do
            gh run view ${{ github.event.workflow_run.id }} --log-failed > ci.log 2>&1 && break
            sleep 10
          done
          if [ ! -s ci.log ]; then
            echo "Failed to download logs after 3 attempts: gh run view returned an error" > ci.log
          fi

      - name: Check if issue already exists
        id: check_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COUNT=$(gh issue list --state open --json title \
          --jq '[.[] | select(.title=="CI Failure — Auto Fix Needed")] | length')
          if [ "$COUNT" -gt 0 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Fix Issue
        if: steps.check_issue.outputs.exists != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.payload.workflow_run.id}`;

            const body = [
              'CI failed.',
              '',
              'Fix only the failing tests.',
              'Do not refactor.',
              'Do not upgrade dependencies.',
              '',
              `[View failed run logs](${runUrl})`,
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "CI Failure — Auto Fix Needed",
              body
            });
